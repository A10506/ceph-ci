#
# Test the expected behavior of the code that ensures proper encoding
# when
#
#    CEPH_FEATURE_OSD_HITSET_GMT
#
# feature is not active (prevents mon overload on upgrade to jewel)
#
roles:
- - mon.a
  - osd.0
  - osd.1
- - osd.2
openstack:
- volumes: # attached to each instance
    count: 2
    size: 10 # GB
tasks:
- print: "**** Install v0.94.6
- install:
    tag: v0.94.6
- ceph:
    fs: xfs
- print: "*** Upgrade the target that runs osd.0 and osd.1 to -x while the target that runs osd.2 stays v0.94.6"
- install.upgrade:
    osd.0:
- print: "*** Restart mon.a and osd.0 so they run jewel
- ceph.restart:
    daemons: [mon.a, osd.0, osd.1]
    wait-for-osds-up: false
    wait-for-healthy: false
- exec:
    osd.0:
      - |-
        set -x
        failed=false
        for delay in 1 2 4 8 16 32 64 128 256 512 1024 ; do 
          if ceph daemon osd.0 log flush ; then
            if grep -E "failed to encode map e[0-9]+ with expected crc" /var/log/ceph/ceph-osd.0.log ; then
              failed=true
              break
            fi
          fi
          sleep $delay
        done
        $failed && exit 1

          sleep $delay
          ceph osd dump
        done
        $success || exit 1

- print: "*** Upgrade the target that runs osd.2 to -x and verify the cluster is back to being healthy"
- install.upgrade:
    osd.2:
- ceph.restart:
    daemons: [osd.2]
    wait-for-healthy: false
- exec:
    mon.a:
      - sleep 300 # http://tracker.ceph.com/issues/17808
      - ceph osd set require_jewel_osds
- ceph.healthy:
